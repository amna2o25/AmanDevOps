name: ğŸš€ Deploy Website with CI/CD

on:
  push:
    branches:
      - main

jobs:
  # CI job - PHP & HTML/CSS lint & test
  ci:
    name: âœ… Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          tools: composer, phpunit

      - name: ğŸ“¦ Install Composer packages
        run: composer install

      - name: âœ… PHP Lint
        run: find . -name "*.php" -print0 | xargs -0 -n1 php -l

      - name: ğŸ§ª Run PHPUnit tests
        run: vendor/bin/phpunit --configuration phpunit.xml

      - name: ğŸ§° Setup Node for Linting
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ¯ Lint HTML/CSS
        run: |
          npm install -g htmlhint stylelint stylelint-config-standard
          htmlhint "**/*.html"

  # Deploy to staging
  deploy-staging:
    name: ğŸ“‚ Deploy to Staging
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¤ FTP Upload to Staging
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_STAGING_SERVER }}
          username: ${{ secrets.FTP_STAGING_USERNAME }}
          password: ${{ secrets.FTP_STAGING_PASSWORD }}
          server-dir: /public_html/L5SW/Amna/

  # Health check
  health-check-staging:
    name: ğŸ©º Check Staging Health
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - name: ğŸ” Check URL status
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://digitalwhiz.co.uk/L5SW/Amna)
          if [ "$STATUS" -ne 200 ]; then
            echo "âŒ Health check failed with status $STATUS"
            exit 1
          fi

  # Deploy to production
  deploy-prod:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: health-check-staging
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¤ FTP Upload to Production
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_PROD_SERVER }}
          username: ${{ secrets.FTP_PROD_USERNAME }}
          password: ${{ secrets.FTP_PROD_PASSWORD }}
          server-dir: /public_html/L5SW/Amna/

  # Health check after prod deploy
  health-check-prod:
    name: ğŸ©º Check Production Health
    runs-on: ubuntu-latest
    needs: deploy-prod
    steps:
      - name: ğŸ” Check URL status
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://digitalwhiz.co.uk/L5SW/Amna)
          if [ "$STATUS" -ne 200 ]; then
            echo "âŒ Health check failed with status $STATUS"
            exit 1
          fi
