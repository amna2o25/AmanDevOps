name: ğŸŒ Full CI/CD + IaC + Monitoring + Scalability

on:
  push:
    branches: [main]

jobs:
  ci:
    name: âœ… Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§ª Basic syntax test (PHP example)
        run: |
          find . -name "*.php" -print0 | xargs -0 -n1 php -l || exit 1

  iac:
    name: ğŸ›  Simulated IaC (Terraform)
    runs-on: ubuntu-latest
    needs: ci
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.4.0

      - run: terraform init

      - run: terraform apply -auto-approve

  deploy:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: iac
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“‚ Upload via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /public_html/L5SW/Amna/

  monitor:
    name: ğŸ©º Check Staging Health
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: ğŸŒ Health check
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://digitalwhiz.co.uk/L5SW/Amna/)
          if [ "$STATUS" -ne 200 ]; then
            echo "âŒ Health check failed with $STATUS"; exit 1
          else
            echo "âœ… Health check passed with $STATUS"
          fi

  load-test:
    name: âš¡ Load Testing
    runs-on: ubuntu-latest
    needs: monitor
    steps:
      - name: ğŸ›  Install k6 for load testing
        run: |
          sudo apt-get update && sudo apt-get install -y gnupg2 curl
          curl -s https://dl.k6.io/key.gpg | sudo apt-key add -
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update && sudo apt-get install -y k6

      - name: ğŸ“ˆ Run k6 test
        run: |
          echo 'import http from "k6/http"; export default function () { http.get("https://digitalwhiz.co.uk/L5SW/Amna/"); }' > test.js
          k6 run --vus 10 --duration 10s test.js
